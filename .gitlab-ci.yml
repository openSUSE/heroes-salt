image: registry.opensuse.org/opensuse/infrastructure/containers/heroes-salt-testing:latest

stages:
  - test
  - deploy

validate:
  image: registry.opensuse.org/opensuse/infrastructure/containers_tumbleweed/heroes-salt-validation:latest
  stage: test
  script: bin/test_validate.sh
  tags:
    - docker
  rules:
    - if: $CI_COMMIT_BRANCH

show_highstate:
  stage: test
  before_script:
    - bin/prepare_test_env.sh -g -o Leap,15,4 -s
    - bin/get_formulas.py -c -d /srv/formula -s --clone-from 'https://gitlab.infra.opensuse.org/saltstack-formulas' --clone-branch production
  script: bin/test_show_highstate.sh
  tags:
    - docker
  artifacts:
    #when: on_failure
    paths:
      - '*.txt'
  rules:
    - if: $CI_COMMIT_BRANCH

test_haproxy:
  image: registry.opensuse.org/opensuse/infrastructure/containers/heroes-salt-testing-haproxy:latest
  stage: test
  before_script:
    - bin/prepare_test_env.sh -g -s -n
    - bin/replace_secrets.sh
    - bin/get_formulas.py -c -d /srv/formula -s --clone-from 'https://gitlab.infra.opensuse.org/saltstack-formulas' --clone-branch production -f haproxy
  script: bin/test_haproxy.sh
  tags:
    - docker
  artifacts:
    when: always
    paths:
      - '*.txt'
  rules:
    - if: $CI_COMMIT_BRANCH
#     changes:
#       - bin/test_haproxy.sh
#       - pillar/cluster/*/*
#       - pillar/common/haproxy/*
#       - salt/profile/proxy/*
#       - salt/role/proxy*

.test_highstate:
  image: registry.opensuse.org/opensuse/infrastructure/containers/heroes-salt-testing-systemd:latest
  stage: test
  before_script:
    - bin/prepare_test_env.sh -g -o Leap,15,5 -s -n
    - bin/get_formulas.py -c -d /srv/formula -s --clone-from 'https://gitlab.infra.opensuse.org/saltstack-formulas' --clone-branch production
  tags:
    - docker
  artifacts:
    when: always
    paths:
      - '*.txt'
  rules:
    - if: $CI_COMMIT_BRANCH

test_highstate_1:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '1,5'

test_highstate_2:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '6,10'

test_highstate_3:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '11,15'

test_highstate_4:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '16,20'

test_highstate_5:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '21,25'

test_highstate_6:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '26,30'

test_highstate_7:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '31,35'

test_highstate_8:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '36,40'

test_highstate_9:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '41,45'

test_highstate_10:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '46,50'

test_highstate_11:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '51,55'

test_highstate_12:
  extends:
    - .test_highstate
  script: bin/test_highstate.sh '56,$'


test_nginx:
  image: registry.opensuse.org/opensuse/infrastructure/containers/heroes-salt-testing-nginx:latest
  stage: test
  before_script:
    - bin/prepare_test_env.sh -g -s
    - bin/get_formulas.py -c -d /srv/formula -s --clone-from 'https://gitlab.infra.opensuse.org/saltstack-formulas' --clone-branch production -f nginx
  script: bin/test_nginx.sh
  tags:
    - docker
  artifacts:
    when: always
    paths:
      - '*.txt'
  rules:
    - if: $CI_COMMIT_BRANCH

test_sudo:
  stage: test
  before_script:
    - bin/prepare_test_env.sh -g -s -n
    - bin/get_formulas.py -c -d /srv/formula -s --clone-from 'https://gitlab.infra.opensuse.org/saltstack-formulas' --clone-branch production
  script: bin/test_sudo.sh
  tags:
    - docker
  rules:
    - if: $CI_COMMIT_BRANCH

deploy_job:
  stage: deploy
  script:
    - "rsync -a --delete --super --owner --group --chown=477:479 --chmod='u=rwX,g=rX,o=' $PWD/ rsync://saltpush@witch1.infra.opensuse.org:873/salt-push/"
  tags:
    - docker
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
